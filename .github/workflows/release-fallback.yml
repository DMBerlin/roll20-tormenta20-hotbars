name: Create Release (Fallback)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for'
        required: true
        default: 'v0.4.1'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 10.15.0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.15.1'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Build extension
      run: pnpm run build
      
    - name: Verify build output
      run: |
        echo "ğŸ“ Build output contents:"
        ls -la dist/package/
        echo "ğŸ“¦ Extension files:"
        ls -la dist/package/*.js dist/package/*.json dist/package/*.html dist/package/*.png || true
      
    - name: Create release package
      run: |
        cd dist/package
        zip -r ../../tormenta20-hotbars-${{ github.event.inputs.tag }}.zip .
        cd ../..
        echo "ğŸ“¦ Package created: tormenta20-hotbars-${{ github.event.inputs.tag }}.zip"
        ls -la tormenta20-hotbars-${{ github.event.inputs.tag }}.zip
        
    - name: Create GitHub Release (Manual)
      run: |
        echo "ğŸ“‹ Release criada manualmente:"
        echo "Tag: ${{ github.event.inputs.tag }}"
        echo "Arquivo: tormenta20-hotbars-${{ github.event.inputs.tag }}.zip"
        echo ""
        echo "ğŸ”§ Para criar a release manualmente:"
        echo "1. VÃ¡ para: https://github.com/DMBerlin/roll20-tormenta20-hotbars/releases"
        echo "2. Clique em 'Create a new release'"
        echo "3. Selecione a tag: ${{ github.event.inputs.tag }}"
        echo "4. FaÃ§a upload do arquivo: tormenta20-hotbars-${{ github.event.inputs.tag }}.zip"
        echo "5. Adicione as notas da release"
        echo "6. Publique a release"
        
    - name: Upload Release Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-package-${{ github.event.inputs.tag }}
        path: tormenta20-hotbars-${{ github.event.inputs.tag }}.zip
        retention-days: 30
